<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Antique Auction System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a1a;
            color: #f5f5f5;
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
        }
        .dashboard-card {
            background-color: #2a2a2a;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background-color: #fbbf24;
            color: #1a1a1a;
        }
        .tab-button:not(.active):hover {
            background-color: #3a3a3a;
            color: #f5f5f5;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .status-live { color: #22c55e; }
        .status-upcoming { color: #3b82f6; }
        .status-closed { color: #ef4444; }
        .status-leading { color: #22c55e; }
        .status-outbid { color: #ef4444; }
        .status-won { color: #fbbf24; }
        .document-status-verified { color: #22c55e; }
        .document-status-pending { color: #f59e0b; }
        .document-status-rejected { color: #ef4444; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-gray-900 shadow-sm py-4 px-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <a href="#" class="text-2xl font-bold text-white font-serif">Antique Auction</a>
            </div>
            <div class="hidden md:flex space-x-8">
                <a href="#" class="text-gray-300 hover:text-amber-400">Home</a>
                <a href="#" class="text-gray-300 hover:text-amber-400">Auctions</a>
                <a href="#" class="text-gray-300 hover:text-amber-400">Categories</a>
                <a href="#" class="text-gray-300 hover:text-amber-400">Blog</a>
                <a href="#" class="text-gray-300 hover:text-amber-400">About</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <i class="fas fa-bell text-gray-300 text-xl cursor-pointer hover:text-amber-400" id="notificationBell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </div>
                <button class="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition">{{ user.first_name }} {{ user.last_name }}</button>
                <a href="{{ url_for('auth.logout') }}" class="px-4 py-2 text-gray-300 hover:text-amber-600">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content - Dashboard -->
    <main class="py-16 px-6 bg-gray-800">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-4xl font-bold text-white mb-8">Welcome, {{ user.first_name }}</h1>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column (Main Content) -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- 1. Auction Overview Section -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Auction Overview</h2>
                        {% if active_items %}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% for item in active_items %}
                                    <div class="bg-gray-700 rounded-lg p-4 flex items-center space-x-4">
                                        <img src="{{ item.auction_item.image or 'https://via.placeholder.com/100' }}"
                                             alt="{{ item.auction_item.title }}"
                                             class="w-24 h-24 object-cover rounded-md">
                                        <div>
                                            <h3 class="text-lg font-bold text-white">{{ item.auction_item.title }}</h3>
                                            <p class="text-gray-400 text-sm">
                                                Starts: {{ item.start_time.strftime('%b %d, %Y %H:%M') if item.start_time else 'N/A' }}
                                            </p>
                                            <p class="text-gray-300">
                                                Current Bid: <span class="font-bold text-amber-400">₹{{ "{:,.2f}".format(item.current_price) }}</span>
                                            </p>
                                            <p class="text-gray-400 text-sm">
                                                Ends: {{ item.end_time.strftime('%b %d, %Y %H:%M') if item.end_time else 'N/A' }}
                                            </p>
                                            {% if item.is_active and item.end_time > now %}
                                                <span class="text-sm font-semibold status-live">Live</span>
                                                <a href="{{ url_for('auctions.live_stream', item_id=item.auction_item.id) }}"
                                                   class="mt-2 inline-block bg-amber-600 hover:bg-amber-700 text-white text-sm py-1 px-3 rounded-md">
                                                    Continue Bidding
                                                </a>
                                            {% else %}
                                                <span class="text-sm font-semibold status-closed">Closed</span>
                                                <button class="mt-2 bg-gray-600 text-white text-sm py-1 px-3 rounded-md" disabled>Closed</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-gray-400 py-4">
                                <span class="text-sm font-semibold">No active auctions at the moment.</span>
                            </div>
                        {% endif %}
                    </div>

                    <!-- 2. Bid Management -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Bid Management</h2>
                        <h3 class="text-xl font-bold text-white mb-3">Your Active Bids</h3>
                        <div class="space-y-4 mb-6">
                            {% for bid in user.bids if bid.item.auction_end_time > now %}
                                <div class="bg-gray-700 rounded-lg p-4 flex justify-between items-center">
                                    <div>
                                        <p class="text-lg font-bold text-white">{{ bid.item.title }}</p>
                                        <p class="text-gray-400">Your Bid: <span class="font-bold text-amber-400">₹{{ "{:,.2f}".format(bid.bid_amount) }}</span></p>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-semibold {{ 'status-leading' if bid.user_id == bid.item.highest_bidder else 'status-outbid' }}">
                                            {{ 'Leading' if bid.user_id == bid.item.highest_bidder else 'Outbid' }}
                                        </span>
                                        <a href="{{ url_for('auctions.live_stream', item_id=bid.item.id) }}"
                                           class="ml-4 bg-amber-600 hover:bg-amber-700 text-white text-sm py-1 px-3 rounded-md">
                                            {{ 'Increase Bid' if bid.user_id != bid.item.highest_bidder else 'View Auction' }}
                                        </a>
                                    </div>
                                </div>
                            {% else %}
                                <p class="text-gray-400">No active bids at the moment.</p>
                            {% endfor %}
                        </div>

                        <h3 class="text-xl font-bold text-white mb-3">Bid History</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-gray-700 rounded-lg">
                                <thead>
                                    <tr class="bg-gray-600 text-left text-gray-300 uppercase text-sm">
                                        <th class="py-3 px-4 rounded-tl-lg">Item</th>
                                        <th class="py-3 px-4">Bid Amount</th>
                                        <th class="py-3 px-4">Bid Time</th>
                                        <th class="py-3 px-4 rounded-tr-lg">Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bid in user.bids %}
                                        <tr class="border-b border-gray-600">
                                            <td class="py-3 px-4 text-white">{{ bid.item.title }}</td>
                                            <td class="py-3 px-4 text-amber-400 font-bold">₹{{ "{:,.2f}".format(bid.bid_amount) }}</td>
                                            <td class="py-3 px-4 text-gray-400">{{ bid.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td class="py-3 px-4 font-semibold
                                                {{ 'status-won' if bid.item.is_sold and bid.user_id == bid.item.highest_bidder else 'status-outbid' if bid.item.highest_bidder and bid.user_id != bid.item.highest_bidder else 'status-leading' if bid.user_id == bid.item.highest_bidder else 'status-closed' }}">
                                                {{ 'Won' if bid.item.is_sold and bid.user_id == bid.item.highest_bidder else 'Outbid' if bid.item.highest_bidder and bid.user_id != bid.item.highest_bidder else 'Leading' if bid.user_id == bid.item.highest_bidder else 'Closed' }}
                                            </td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan="4" class="py-3 px-4 text-gray-400 text-center">No bid history available.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="flex items-center mt-4">
                            <input type="checkbox" id="autoBidToggle" class="form-checkbox text-amber-600 h-5 w-5">
                            <label for="autoBidToggle" class="ml-2 text-gray-300">Enable Auto-bid for eligible auctions</label>
                        </div>
                    </div>

                    <!-- 5. My Auctions -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">My Auctions</h2>
                        <div class="flex space-x-4 mb-6">
                            <button class="tab-button active" data-tab="activeBids">Active Bids</button>
                            <button class="tab-button" data-tab="wonAuctions">Won Auctions</button>
                            <button class="tab-button" data-tab="pendingBids">Pending Bids</button>
                            <button class="tab-button" data-tab="missedAuctions">Missed Auctions</button>
                        </div>

                        <div id="activeBidsContent" class="tab-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% for bid in user.bids if bid.item.auction_end_time > now %}
                                    <div class="bg-gray-700 rounded-lg p-4 flex items-center space-x-4">
                                        <img src="{{ bid.item.image or 'https://via.placeholder.com/100' }}"
                                             alt="{{ bid.item.title }}"
                                             class="w-24 h-24 object-cover rounded-md">
                                        <div>
                                            <h3 class="text-lg font-bold text-white">{{ bid.item.title }}</h3>
                                            <p class="text-gray-400 text-sm">Your Bid: <span class="font-bold text-amber-400">₹{{ "{:,.2f}".format(bid.bid_amount) }}</span></p>
                                            <p class="text-gray-400 text-sm">
                                                Time Left: {{ (bid.item.auction_end_time - now).days }}d {{ ((bid.item.auction_end_time - now).seconds // 3600) }}h
                                            </p>
                                            <span class="font-semibold {{ 'status-leading' if bid.user_id == bid.item.highest_bidder else 'status-outbid' }}">
                                                {{ 'Leading' if bid.user_id == bid.item.highest_bidder else 'Outbid' }}
                                            </span>
                                            <a href="{{ url_for('auctions.live_stream', item_id=bid.item.id) }}"
                                               class="mt-2 inline-block bg-amber-600 hover:bg-amber-700 text-white text-sm py-1 px-3 rounded-md">
                                                View Auction
                                            </a>
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="text-gray-400">No active bids at the moment.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <div id="wonAuctionsContent" class="tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {% for item in bought_items %}
                                    <div class="bg-gray-700 rounded-lg p-4 flex items-center space-x-4">
                                        <img src="{{ item.image or 'https://via.placeholder.com/100' }}"
                                             alt="{{ item.title }}"
                                             class="w-24 h-24 object-cover rounded-md">
                                        <div>
                                            <h3 class="text-lg font-bold text-white">{{ item.title }}</h3>
                                            <p class="text-gray-400 text-sm">Winning Bid: <span class="font-bold text-amber-400">₹{{ "{:,.2f}".format(item.current_bid) }}</span></p>
                                            <p class="text-gray-400 text-sm">Payment Status: <span class="text-green-500">{{ 'Paid' if item.payments else 'Pending' }}</span></p>
                                            <p class="text-gray-400 text-sm">Auction Ended: {{ item.auction_end_time.strftime('%B %d, %Y') }}</p>
                                            <button class="mt-2 bg-green-600 hover:bg-green-700 text-white text-sm py-1 px-3 rounded-md">Download Invoice</button>
                                        </div>
                                    </div>
                                {% else %}
                                    <p class="text-gray-400">No purchases yet.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <div id="pendingBidsContent" class="tab-content hidden">
                            <p class="text-gray-400">No pending bids at the moment.</p>
                        </div>

                        <div id="missedAuctionsContent" class="tab-content hidden">
                            <p class="text-gray-400">No missed auctions.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column (Side Content) -->
                <div class="lg:col-span-1 space-y-8">
                    <!-- 4. Notifications Center -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Notifications</h2>
                        <div class="space-y-3">
                            {% for bid in user.bids %}
                                {% if bid.item.highest_bidder != bid.user_id and bid.item.auction_end_time > now %}
                                    <div class="flex items-start space-x-3">
                                        <i class="fas fa-gavel text-amber-400 mt-1"></i>
                                        <div>
                                            <p class="text-white font-semibold">You've been outbid on "{{ bid.item.title }}"!</p>
                                            <p class="text-gray-400 text-sm">Current bid is ₹{{ "{:,.2f}".format(bid.item.current_bid) }}. Bid again to win!</p>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-bell text-blue-400 mt-1"></i>
                                <div>
                                    <p class="text-white font-semibold">Auction "Rare Pocket Watches" starts in 24 hours!</p>
                                    <p class="text-gray-400 text-sm">Don't miss out on this exclusive collection.</p>
                                </div>
                            </div>
                            {% for item in bought_items if item.payments %}
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-check-circle text-green-400 mt-1"></i>
                                    <div>
                                        <p class="text-white font-semibold">Payment for "{{ item.title }}" confirmed.</p>
                                        <p class="text-gray-400 text-sm">Item is now being prepared for shipping.</p>
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-file-alt text-orange-400 mt-1"></i>
                                <div>
                                    <p class="text-white font-semibold">Your KYC ID Proof is Pending Review.</p>
                                    <p class="text-gray-400 text-sm">Please allow 1-2 business days for verification.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Account Information (Summary) -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Account Information</h2>
                        <div class="space-y-3 text-gray-300">
                            <p><span class="font-semibold">Name:</span> {{ user.first_name }} {{ user.last_name }}</p>
                            <p><span class="font-semibold">Email:</span> {{ user.email }}</p>
                            <p><span class="font-semibold">Phone:</span> {{ user.phone_number }}</p>
                            <p><span class="font-semibold">Address:</span> {{ user.street_address }}, {{ user.city }}, {{ user.state_province }}, {{ user.country }}</p>
                            <p><span class="font-semibold">Payment Methods:</span> {{ user.payment_methods|default("N/A") }}</p>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-3">
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Edit Profile</button>
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Change Password</button>
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Manage Payments</button>
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Download Invoices</button>
                        </div>
                    </div>

                    <!-- 6. Document Management -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Document Management</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <p class="text-white">KYC ID Proof</p>
                                <span class="document-status-pending font-semibold">Pending</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-white">Bank Account Proof</p>
                                <span class="document-status-verified font-semibold">Verified</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-white">Business Registration</p>
                                <span class="document-status-rejected font-semibold">Rejected</span>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-3">
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Upload New Document</button>
                            <button class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-2 px-4 rounded-md">Manage Digital Signature</button>
                        </div>
                    </div>

                    <!-- 8. Support & Help -->
                    <div class="dashboard-card">
                        <h2 class="text-2xl font-bold text-amber-400 mb-4">Support & Help</h2>
                        <div class="space-y-3">
                            <a href="#" class="flex items-center text-gray-300 hover:text-amber-400">
                                <i class="fas fa-question-circle mr-3"></i> FAQs
                            </a>
                            <a href="#" class="flex items-center text-gray-300 hover:text-amber-400">
                                <i class="fas fa-book mr-3"></i> Tutorials & Guides
                            </a>
                            <a href="#" class="flex items-center text-gray-300 hover:text-amber-400">
                                <i class="fas fa-headset mr-3"></i> Contact Support
                            </a>
                            <a href="#" class="flex items-center text-gray-300 hover:text-amber-400">
                                <i class="fas fa-ticket-alt mr-3"></i> Raise a Ticket
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-8 px-6 mt-8">
        <div class="max-w-7xl mx-auto text-center text-gray-400">
            <p>© 2023 Antique Auction System. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // --- Real-time Updates (Simulated) ---
        const notificationCount = document.getElementById('notificationCount');
        const serverTimeDisplay = document.createElement('p');
        serverTimeDisplay.className = 'text-gray-400 text-sm mt-4 text-center';
        document.querySelector('.dashboard-card').appendChild(serverTimeDisplay);

        function updateServerTime() {
            const now = new Date();
            serverTimeDisplay.textContent = `Server Time: ${now.toLocaleTimeString()} (GMT)`;
        }
        setInterval(updateServerTime, 1000);
        updateServerTime();

        // Update notification count based on outbids and payments
        let currentNotificationCount = {{ user.bids|selectattr('item.highest_bidder', 'ne', user.id)|selectattr('item.auction_end_time', 'gt', now)|list|length + bought_items|selectattr('payments')|list|length }};
        notificationCount.textContent = currentNotificationCount;

        // Simulate new notification every 10 seconds
        setInterval(() => {
            currentNotificationCount++;
            notificationCount.textContent = currentNotificationCount;
        }, 10000);

        // --- Tab Functionality for My Auctions ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                button.classList.add('active');
                const targetTab = button.dataset.tab;
                document.getElementById(`${targetTab}Content`).classList.remove('hidden');
            });
        });

        // --- Notification Bell Click ---
        notificationBell.addEventListener('click', () => {
            alert(`You have ${notificationCount.textContent} new notifications! (In a real app, this would open a notification panel)`);
        });

        // --- Auto-bid Toggle (Simulated) ---
        const autoBidToggle = document.getElementById('autoBidToggle');
        autoBidToggle.addEventListener('change', (event) => {
            if (event.target.checked) {
                alert('Auto-bid enabled! Your bids will be automatically placed up to your maximum limit.');
            } else {
                alert('Auto-bid disabled.');
            }
        });
    </script>
</body>
</html>